/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.1
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */(function(e){function u(e){return String(e===null||e===undefined?"":e)}function a(e){return u(e).replace(o,function(e){return s[e]})}var t={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,placeholder:null,theme:null,zindex:999,resultsLimit:null,enableHTML:!1,resultsFormatter:function(e){var t=e[this.propertyToSearch];return"<li>"+(this.enableHTML?t:a(t))+"</li>"},tokenFormatter:function(e){var t=e[this.propertyToSearch];return"<li><p>"+(this.enableHTML?t:a(t))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",allowFreeTagging:!1,allowTabOut:!1,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:!1},n={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"},r={BEFORE:0,AFTER:1,END:2},i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},o=/[&<>"'\/]/g,f={init:function(n,r){var i=e.extend({},t,r||{});return this.each(function(){e(this).data("settings",i);e(this).data("tokenInputObject",new e.TokenList(this,n,i))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(e){this.data("tokenInputObject").add(e);return this},remove:function(e){this.data("tokenInputObject").remove(e);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(e){this.data("tokenInputObject").toggleDisabled(e);return this},setOptions:function(t){e(this).data("settings",e.extend({},e(this).data("settings"),t||{}));return this},destroy:function(){if(this.data("tokenInputObject")){this.data("tokenInputObject").clear();var e=this,t=this.parent();t.empty();e.show();t.append(e);return e}}};e.fn.tokenInput=function(e){return f[e]?f[e].apply(this,Array.prototype.slice.call(arguments,1)):f.init.apply(this,arguments)};e.TokenList=function(t,s,o){function T(n){return e(t).data("settings").enableHTML?n:a(n)}function N(n){typeof n=="boolean"?e(t).data("settings").disabled=n:e(t).data("settings").disabled=!e(t).data("settings").disabled;d.attr("disabled",e(t).data("settings").disabled);b.toggleClass(e(t).data("settings").classes.disabled,e(t).data("settings").disabled);m&&D(e(m),r.END);v.attr("disabled",e(t).data("settings").disabled)}function C(){if(e(t).data("settings").tokenLimit!==null&&l>=e(t).data("settings").tokenLimit){d.hide();j();return}}function k(){if(p===(p=d.val()))return;var e=b.width()-d.offset().left-b.offset().left;S.html(a(p)||a(o.placeholder));d.width(Math.min(b.width(),Math.max(e,S.width()+30)))}function L(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function A(){var n=e.trim(d.val()),r=n.split(e(t).data("settings").tokenDelimiter);e.each(r,function(n,r){if(!r)return;e.isFunction(e(t).data("settings").onFreeTaggingAdd)&&(r=e(t).data("settings").onFreeTaggingAdd.call(v,r));var i={};i[e(t).data("settings").tokenValue]=i[e(t).data("settings").propertyToSearch]=r;M(i)})}function O(n){var r=e(e(t).data("settings").tokenFormatter(n)),i=n.readonly===!0?!0:!1;i&&r.addClass(e(t).data("settings").classes.tokenReadOnly);r.addClass(e(t).data("settings").classes.token).insertBefore(w);i||e("<span>"+e(t).data("settings").deleteText+"</span>").addClass(e(t).data("settings").classes.tokenDelete).appendTo(r).click(function(){if(!e(t).data("settings").disabled){H(e(this).parent());v.change();return!1}});var s=n;e.data(r.get(0),"tokeninput",n);f=f.slice(0,g).concat([s]).concat(f.slice(g));g++;B(f,v);l+=1;if(e(t).data("settings").tokenLimit!==null&&l>=e(t).data("settings").tokenLimit){d.hide();j()}return r}function M(n){var r=e(t).data("settings").onAdd;if(l>0&&e(t).data("settings").preventDuplicates){var i=null;b.children().each(function(){var t=e(this),r=e.data(t.get(0),"tokeninput");if(r&&r[o.tokenValue]===n[o.tokenValue]){i=t;return!1}});if(i){_(i);w.insertAfter(i);Y(d);return}}d.width(0);if(e(t).data("settings").tokenLimit==null||l<e(t).data("settings").tokenLimit){O(n);d.attr("placeholder",null);C()}d.val("");j();e.isFunction(r)&&r.call(v,n)}function _(n){if(!e(t).data("settings").disabled){n.addClass(e(t).data("settings").classes.selectedToken);m=n.get(0);d.val("");j()}}function D(n,i){n.removeClass(e(t).data("settings").classes.selectedToken);m=null;if(i===r.BEFORE){w.insertBefore(n);g--}else if(i===r.AFTER){w.insertAfter(n);g++}else{w.appendTo(b);g=l}Y(d)}function P(t){var n=m;m&&D(e(m),r.END);n===t.get(0)?D(t,r.END):_(t)}function H(n){var r=e.data(n.get(0),"tokeninput"),i=e(t).data("settings").onDelete,s=n.prevAll().length;s>g&&s--;n.remove();m=null;Y(d);f=f.slice(0,s).concat(f.slice(s+1));f.length==0&&d.attr("placeholder",o.placeholder);s<g&&g--;B(f,v);l-=1;if(e(t).data("settings").tokenLimit!==null){d.show().val("");Y(d)}e.isFunction(i)&&i.call(v,r)}function B(n,r){var i=e.map(n,function(n){return typeof e(t).data("settings").tokenValue=="function"?e(t).data("settings").tokenValue.call(this,n):n[e(t).data("settings").tokenValue]});r.val(i.join(e(t).data("settings").tokenDelimiter))}function j(){E.hide().empty();y=null}function F(){E.css({position:"absolute",top:b.offset().top+b.outerHeight(),left:b.offset().left,width:b.width(),"z-index":e(t).data("settings").zindex}).show()}function I(){if(e(t).data("settings").searchingText){E.html("<p>"+T(e(t).data("settings").searchingText)+"</p>");F()}}function q(){if(e(t).data("settings").hintText){E.html("<p>"+T(e(t).data("settings").hintText)+"</p>");F()}}function U(e){return e.replace(R,"\\$&")}function z(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+U(t)+")(?![^<>]*>)(?![^&;]+;)","gi"),function(e,t){return"<b>"+T(t)+"</b>"})}function W(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+U(t)+")(?![^<>]*>)(?![^&;]+;)","g"),z(t,n))}function X(n,r){if(r&&r.length){E.empty();var i=e("<ul>").appendTo(E).mouseover(function(t){V(e(t.target).closest("li"))}).mousedown(function(t){M(e(t.target).closest("li").data("tokeninput"));v.change();return!1}).hide();e(t).data("settings").resultsLimit&&r.length>e(t).data("settings").resultsLimit&&(r=r.slice(0,e(t).data("settings").resultsLimit));e.each(r,function(r,s){var o=e(t).data("settings").resultsFormatter(s);o=W(o,s[e(t).data("settings").propertyToSearch],n);o=e(o).appendTo(i);r%2?o.addClass(e(t).data("settings").classes.dropdownItem):o.addClass(e(t).data("settings").classes.dropdownItem2);r===0&&V(o);e.data(o.get(0),"tokeninput",s)});F();e(t).data("settings").animateDropdown?i.slideDown("fast"):i.show()}else if(e(t).data("settings").noResultsText){E.html("<p>"+T(e(t).data("settings").noResultsText)+"</p>");F()}}function V(n){if(n){y&&J(e(y));n.addClass(e(t).data("settings").classes.selectedDropdownItem);y=n.get(0)}}function J(n){n.removeClass(e(t).data("settings").classes.selectedDropdownItem);y=null}function K(){var n=d.val();if(n&&n.length){m&&D(e(m),r.AFTER);if(n.length>=e(t).data("settings").minChars){I();clearTimeout(h);h=setTimeout(function(){Q(n)},e(t).data("settings").searchDelay)}else j()}}function Q(n){var r=n+G(),i=c.get(r);if(i){e.isFunction(e(t).data("settings").onCachedResult)&&(i=e(t).data("settings").onCachedResult.call(v,i));X(n,i)}else if(e(t).data("settings").url){var s=G(),u={};u.data={};if(s.indexOf("?")>-1){var a=s.split("?");u.url=a[0];var f=a[1].split("&");e.each(f,function(e,t){var n=t.split("=");u.data[n[0]]=n[1]})}else u.url=s;u.data[e(t).data("settings").queryParam]=n;u.type=e(t).data("settings").method;u.dataType=e(t).data("settings").contentType;e(t).data("settings").crossDomain&&(u.dataType="jsonp");u.success=function(i){c.add(r,e(t).data("settings").jsonContainer?i[e(t).data("settings").jsonContainer]:i);e.isFunction(e(t).data("settings").onResult)&&(i=e(t).data("settings").onResult.call(v,i));d.val()===n&&X(n,e(t).data("settings").jsonContainer?i[e(t).data("settings").jsonContainer]:i)};o.onSend&&o.onSend(u);e.ajax(u)}else if(e(t).data("settings").local_data){var l=e.grep(e(t).data("settings").local_data,function(r){return r[e(t).data("settings").propertyToSearch].toLowerCase().indexOf(n.toLowerCase())>-1});c.add(r,l);e.isFunction(e(t).data("settings").onResult)&&(l=e(t).data("settings").onResult.call(v,l));X(n,l)}}function G(){var n=e(t).data("settings").url;typeof e(t).data("settings").url=="function"&&(n=e(t).data("settings").url.call(e(t).data("settings")));return n}function Y(e){setTimeout(function(){e.focus()},50)}if(e.type(s)==="string"||e.type(s)==="function"){e(t).data("settings").url=s;var u=G();e(t).data("settings").crossDomain===undefined&&typeof u=="string"&&(u.indexOf("://")===-1?e(t).data("settings").crossDomain=!1:e(t).data("settings").crossDomain=location.href.split(/\/+/g)[1]!==u.split(/\/+/g)[1])}else typeof s=="object"&&(e(t).data("settings").local_data=s);if(e(t).data("settings").classes)e(t).data("settings").classes=e.extend({},n,e(t).data("settings").classes);else if(e(t).data("settings").theme){e(t).data("settings").classes={};e.each(n,function(n,r){e(t).data("settings").classes[n]=r+"-"+e(t).data("settings").theme})}else e(t).data("settings").classes=n;var f=[],l=0,c=new e.TokenList.Cache,h,p,d=e('<input type="text"  autocomplete="off" autocapitalize="off">').css({outline:"none"}).attr("id",e(t).data("settings").idPrefix+t.id).focus(function(){if(e(t).data("settings").disabled)return!1;(e(t).data("settings").tokenLimit===null||e(t).data("settings").tokenLimit!==l)&&q();b.addClass(e(t).data("settings").classes.focused)}).blur(function(){j();e(t).data("settings").allowFreeTagging&&A();e(this).val("");b.removeClass(e(t).data("settings").classes.focused)}).bind("keyup keydown blur update",k).keydown(function(n){var s,o;switch(n.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(!e(this).val()){s=w.prev();o=w.next();s.length&&s.get(0)===m||o.length&&o.get(0)===m?n.keyCode===i.LEFT||n.keyCode===i.UP?D(e(m),r.BEFORE):D(e(m),r.AFTER):n.keyCode!==i.LEFT&&n.keyCode!==i.UP||!s.length?(n.keyCode===i.RIGHT||n.keyCode===i.DOWN)&&o.length&&_(e(o.get(0))):_(e(s.get(0)))}else{var u=null;n.keyCode===i.DOWN||n.keyCode===i.RIGHT?u=e(y).next():u=e(y).prev();u.length&&V(u)}return!1;case i.BACKSPACE:s=w.prev();if(!e(this).val().length){if(m){H(e(m));v.change()}else s.length&&_(e(s.get(0)));return!1}e(this).val().length===1?j():setTimeout(function(){K()},5);break;case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:case i.COMMA:if(y){M(e(y).data("tokeninput"));v.change()}else{if(e(t).data("settings").allowFreeTagging){if(e(t).data("settings").allowTabOut&&e(this).val()==="")return!0;A()}else{e(this).val("");if(e(t).data("settings").allowTabOut)return!0}n.stopPropagation();n.preventDefault()}return!1;case i.ESCAPE:j();return!0;default:String.fromCharCode(n.which)&&setTimeout(function(){K()},5)}});o.placeholder&&d.attr("placeholder",o.placeholder);var v=e(t).hide().val("").focus(function(){Y(d)}).blur(function(){d.blur();return v}),m=null,g=0,y=null,b=e("<ul />").addClass(e(t).data("settings").classes.tokenList).click(function(t){var n=e(t.target).closest("li");if(n&&n.get(0)&&e.data(n.get(0),"tokeninput"))P(n);else{m&&D(e(m),r.END);Y(d)}}).mouseover(function(n){var r=e(n.target).closest("li");r&&m!==this&&r.addClass(e(t).data("settings").classes.highlightedToken)}).mouseout(function(n){var r=e(n.target).closest("li");r&&m!==this&&r.removeClass(e(t).data("settings").classes.highlightedToken)}).insertBefore(v),w=e("<li />").addClass(e(t).data("settings").classes.inputToken).appendTo(b).append(d),E=e("<div>").addClass(e(t).data("settings").classes.dropdown).appendTo("body").hide(),S=e("<tester/>").insertAfter(d).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:d.css("fontSize"),fontFamily:d.css("fontFamily"),fontWeight:d.css("fontWeight"),letterSpacing:d.css("letterSpacing"),whiteSpace:"nowrap"});v.val("");var x=e(t).data("settings").prePopulate||v.data("pre");e(t).data("settings").processPrePopulate&&e.isFunction(e(t).data("settings").onResult)&&(x=e(t).data("settings").onResult.call(v,x));x&&x.length&&e.each(x,function(e,t){O(t);C();d.attr("placeholder",null)});e(t).data("settings").disabled&&N(!0);e.isFunction(e(t).data("settings").onReady)&&e(t).data("settings").onReady.call();this.clear=function(){b.children("li").each(function(){e(this).children("input").length===0&&H(e(this))})};this.add=function(e){M(e)};this.remove=function(t){b.children("li").each(function(){if(e(this).children("input").length===0){var n=e(this).data("tokeninput"),r=!0;for(var i in t)if(t[i]!==n[i]){r=!1;break}r&&H(e(this))}})};this.getTokens=function(){return f};this.toggleDisabled=function(e){N(e)};k();var R=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g")};e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),r={},i=0,s=function(){r={};i=0};this.add=function(e,t){i>n.max_size&&s();r[e]||(i+=1);r[e]=t};this.get=function(e){return r[e]}}})(jQuery);